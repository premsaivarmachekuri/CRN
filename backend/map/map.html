<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaflet Map with Distance Calculation</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />

    <style>
      #map {
        height: 700px;
      }
      .distance-label {
        padding: 4px;
        border: 1px solid #ccc;
        border-radius: bold;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>


    <!-- THESE ARE INPUT FIELDS FOR LATITUDE AND LONGITUDE -->

    <!-- Create input fields for the source marker's latitude and longitude -->
    
    <div>
      <label for="latitude1">Source Latitude (Marker 1):</label>
      <input type="text" id="latitude1" placeholder="Enter latitude" />
    </div>
    <div>
      <label for="longitude1">Source Longitude (Marker 1):</label>
      <input type="text" id="longitude1" placeholder="Enter longitude" />
    </div>

    <!-- Button to add source marker -->
    <button id="addSourceMarker">Add Source Marker</button>

    <!-- Button to calculate shortest distance -->
    <button id="calculateShortestDistance">Calculate Shortest Distance</button>

    <!-- Display the shortest distance and closest destination marker -->
    <div id="distance">Shortest Distance: N/A</div>

    <!-- Create input fields for adding new destination markers -->
    <div>
      <label for="newLatitude">New Destination Latitude:</label>
      <input type="text" id="newLatitude" placeholder="Enter latitude" />
    </div>
    <div>
      <label for="newLongitude">New Destination Longitude:</label>
      <input type="text" id="newLongitude" placeholder="Enter longitude" />
    </div>
    <button id="addMarker">Add Destination Marker</button>

    <!-- Include Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- JavaScript for the map and distance calculation -->
    <script>

        // DISTANCE FUNCTION
      // Function to calculate the distance using Haversine formula
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the Earth in kilometers

        // Convert latitude and longitude from degrees to radians
        const lat1Rad = (lat1 * Math.PI) / 180;
        const lon1Rad = (lon1 * Math.PI) / 180;
        const lat2Rad = (lat2 * Math.PI) / 180;
        const lon2Rad = (lon2 * Math.PI) / 180;

        // Haversine formula
        const dLat = lat2Rad - lat1Rad;
        const dLon = lon2Rad - lon1Rad;

        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1Rad) *
            Math.cos(lat2Rad) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        // Calculate the distance
        const distance = R * c;

        return distance; // Distance in kilometers
      }

      // Create a map instance and set its view to a specific location and zoom level
      var map = L.map('map').setView([17.8868, 83.3185], 10); // Adjusted view for better visibility

      // Add an OpenStreetMap tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);
      
    //   //changing the color of the source marker
    //   var sourceMarkerColor = L.divIcon({
    //     className: 'custom-source-icon',
    //     html: '<i class="fas fa-map-marker-alt fa-2x" style="color: red;"></i>',
    //     iconSize: [32,32],
    // //use this function to change the color of the source marker
    // })

    // Initialize markers
      var sourceMarker;
      var distanceMarker;
      var destinationMarkers = []; //USED AN EMPTY ARRAY FOR MULTIPLE NODES

      // Function to add the source marker
      function addSourceMarker() {
        const latitude1 = parseFloat(document.getElementById('latitude1').value);
        const longitude1 = parseFloat(document.getElementById('longitude1').value);

        // Check if input values are valid for the source marker
        if (isNaN(latitude1) || isNaN(longitude1)) {
          alert('Please enter valid latitude and longitude for the source marker.');
          return;
        }

        // Remove the existing source marker if it exists
        if (sourceMarker) {
          map.removeLayer(sourceMarker);
        }

        // Create a new source marker and add it to the map
        sourceMarker = L.marker([latitude1, longitude1],).addTo(map);
      }

      // Add a click event listener to the "Add Source Marker" button
      document.getElementById('addSourceMarker').addEventListener('click', addSourceMarker);

      // Function to update markers and find the shortest distance
      function updateMarkersAndFindShortestDistance() {
        const latitude1 = parseFloat(document.getElementById('latitude1').value);
        const longitude1 = parseFloat(document.getElementById('longitude1').value);

        // Check if input values are valid for the source marker
        if (isNaN(latitude1) || isNaN(longitude1)) {
          alert('Please enter valid latitude and longitude for the source marker.');
          return;
        }

        // Calculate distances to each destination marker and draw lines
        let shortestDistance = Infinity;
        let closestDestinationMarker = null;
        let shortestDistancePolyline = null;

        destinationMarkers.forEach(destination => {
          const { latitude, longitude } = destination;
          const distance = calculateDistance(latitude1, longitude1, latitude, longitude);

          // Update shortest distance and closest destination marker if needed
          if (distance < shortestDistance) {
            shortestDistance = distance;
            closestDestinationMarker = destination;
          }

          // Draw a line between source and destination markers
          const polyline = L.polyline(
            [
              [latitude1, longitude1],
              [latitude, longitude],
            ],
            {
              color: 'red', // Line color
              weight: 2, // Line thickness
            }
          ).addTo(map);

          // Check if this is the shortest distance polyline
          if (distance === shortestDistance) {
            shortestDistancePolyline = polyline;
          }
        });

        // Update the HTML with the shortest distance and closest destination marker details
        const distanceElement = document.getElementById('distance');
        if (closestDestinationMarker) {
          distanceElement.textContent = `Shortest distance: ${shortestDistance.toFixed(2)} kilometers to Destination Marker`;
        } else {
          distanceElement.textContent = `No destinations added.`;
        }
        // Remove previous shortest distance polyline if it exists
        if (distanceMarker) {
          map.removeLayer(distanceMarker);
        }

        // Calculate the midpoint of the shortest distance and add a marker for the distance label
        const midpoint = shortestDistancePolyline.getCenter();
        const distanceIcon = L.divIcon({
          className: 'distance-label',
          html: `${shortestDistance.toFixed(2)} km`,
        });
        distanceMarker = L.marker(midpoint, { icon: distanceIcon }).addTo(map);
      }

      // Add a click event listener to the "Calculate Shortest Distance" button
      document.getElementById('calculateShortestDistance').addEventListener('click', function () {
        addSourceMarker(); // Call the function to add the source marker
        updateMarkersAndFindShortestDistance(); // Call the function to calculate distances
      });

      // Function to add a new destination marker to the array
      function addMarker() {
        const latitude = parseFloat(document.getElementById('newLatitude').value);
        const longitude = parseFloat(document.getElementById('newLongitude').value);

        if (isNaN(latitude) || isNaN(longitude)) {
          alert(`Please enter valid latitude and longitude for the new destination marker.`);
          return;
        }

        // Add the new destination marker to the array
        destinationMarkers.push({ latitude, longitude });

        // Creating a new marker for the destination
        const newMarker = L.marker([latitude, longitude]).addTo(map);
        newMarker.bindPopup(`Destination Marker<br>Latitude: ${latitude}<br>Longitude: ${longitude}`);
      }

      // Add a click event listener to the "Add Destination Marker" button
      document.getElementById('addMarker').addEventListener('click', addMarker);

    </script>
  </body>
</html>
